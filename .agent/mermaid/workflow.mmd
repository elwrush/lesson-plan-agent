graph TD
    Start([Start]) --> Define_Params[Define Goal, CEFR Level, and Target Word Count]
    Define_Params --> Input_Choice{Input Type?}
    
    Input_Choice -->|Bespoke| Get_Topic[Input: Theme/Topic]
    Input_Choice -->|Adaptation| Get_Text[Input: Base Text]
    
    subgraph 'External Logic'
    Ling_Analysis[[Linguistic Analysis<br>(Rhetorical, Cohesion, Lexis, Grammar)]]
    end
    
    Get_Topic --> Draft_Phase
    Get_Text --> Draft_Phase
    Ling_Analysis -.->|Informs Features| Draft_Phase[Generate User Text]
    
    Draft_Phase --> Validation_Gate{'Gate: Word Count Check<br>(Python Script)'}
    
    Validation_Gate -->|Fail: Too Long/Short| Refine[Adjust Length & Complexity]
    Refine --> Validation_Gate
    
    Validation_Gate -->|Pass| Glossary_Choice{Create Glossary?}
    
    Glossary_Choice -->|No| Final_Output([Final Output])
    Glossary_Choice -->|Yes| Ask_Count[User Prompt: How many words?]
    
    Ask_Count --> Select_Vocab[Select terms based on CEFR difficulty]
    Select_Vocab --> Gen_Glossary[Generate Glossary Definitions<br>(Word /phonemic/ : Graded Definition)]
    Gen_Glossary --> Final_Output

    style Validation_Gate fill:#ff9,stroke:#d35400,stroke-width:4px
    style Ling_Analysis fill:#e8daef,stroke:#8e44ad,stroke-width:2px,stroke-dasharray: 5 5
    style Glossary_Choice fill:#ff9,stroke:#d35400,stroke-width:4px
