<section {% if slide.image %} data-background="{{ slide.image }}"
    data-background-opacity="{{ slide.get('data-background-opacity', 0.5) }}" {% endif %} {% if
    slide.background_gradient %} data-background-gradient="{{ slide.background_gradient }}" {% endif %}
    data-auto-animate>

    <div
        style="display: grid; grid-template-columns: 1fr; gap: 20px; align-items: start; height: 100%; max-width: 1200px; margin: auto; text-align: left;">

        <div style="background: rgba(0,0,0,0.6); padding: 40px; border-radius: 12px; position: relative;">
            <h2
                style="color: var(--accent); margin-bottom: 20px; text-shadow: 2px 2px 8px rgba(0,0,0,0.9); font-size: 1.0em;">
                {{ slide.title }}</h2>

            {% if slide.rationale %}
            <div
                style="font-size: 0.8em; background: rgba(255, 215, 0, 0.15); border-left: 3px solid #FFD700; padding: 10px; margin-bottom: 25px; color: #eee; font-style: italic;">
                <i class="fas fa-heart" style="color: #FFD700; margin-right: 5px;"></i> <b>Teacher's Tip:</b> {{
                slide.rationale }}
            </div>
            {% endif %}

            <div
                style="display: flex; justify-content: space-between; position: relative; padding: 20px 0; font-size: 0.9em;">
                <!-- SVG Layer (Overlay) -->
                <svg id="match-svg-{{ slide.id }}"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; overflow: visible;">
                    <!-- Lines will be injected here -->
                </svg>

                <!-- Left Col -->
                <div style="display: flex; flex-direction: column; gap: 20px; width: 35%;">
                    {% for item in slide.left_items %}
                    <div id="left-{{ slide.id }}-{{ loop.index0 }}"
                        style="padding: 15px; background: rgba(50,50,50,0.8); border-radius: 8px; text-align: center; border: 1px solid var(--accent); z-index: 5;">
                        {{ item }}
                    </div>
                    {% endfor %}
                </div>

                <!-- Right Col -->
                <div style="display: flex; flex-direction: column; gap: 20px; width: 35%;">
                    {% for item in slide.right_items %}
                    <div id="right-{{ slide.id }}-{{ loop.index0 }}"
                        style="padding: 15px; background: rgba(50,50,50,0.8); border-radius: 8px; text-align: center; border: 1px solid white; z-index: 5;">
                        {{ item }}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Triggers -->
            {% for conn in slide.connections %}
            <div class="fragment" data-fragment-index="{{ loop.index0 }}"
                data-match-trigger='{"from": "left-{{ slide.id }}-{{ conn.from }}", "to": "right-{{ slide.id }}-{{ conn.to }}"}'>
            </div>
            {% endfor %}

        </div>
    </div>

    <script>
        Reveal.on('fragmentshown', event => {
            const trigger = event.fragment.getAttribute('data-match-trigger');
            if (trigger) {
                const data = JSON.parse(trigger);
                const fromEl = document.getElementById(data.from);
                const toEl = document.getElementById(data.to);
                const svg = fromEl.closest('div').querySelector('svg'); // Find closest container SVG

                if (fromEl && toEl && svg) {
                    const fromRect = fromEl.getBoundingClientRect();
                    const toRect = toEl.getBoundingClientRect();
                    const svgRect = svg.getBoundingClientRect();

                    const x1 = fromRect.right - svgRect.left;
                    const y1 = fromRect.top + fromRect.height / 2 - svgRect.top;
                    const x2 = toRect.left - svgRect.left;
                    const y2 = toRect.top + toRect.height / 2 - svgRect.top;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x1);
                    line.setAttribute('y2', y1);
                    line.setAttribute('stroke', '#FFD700');
                    line.setAttribute('stroke-width', '4');
                    line.setAttribute('stroke-linecap', 'round');

                    svg.appendChild(line);

                    // Force reflow
                    line.getBoundingClientRect();

                    setTimeout(() => {
                        line.style.transition = 'all 0.5s cubic-bezier(0.25, 0.1, 0.25, 1.0)';
                        line.setAttribute('x2', x2);
                        line.setAttribute('y2', y2);
                    }, 50);
                }
            }
        });
    </script>
</section>